import React, { useState, useEffect } from 'react';
import { 
  Upload, 
  FileText, 
  AlertTriangle, 
  CheckCircle, 
  DollarSign, 
  Sparkles, 
  Search, 
  ChevronRight, 
  FileCheck,
  RefreshCw,
  ShieldAlert,
  File
} from 'lucide-react';

// --- 模拟数据与工具函数 ---

// 常见合同易错词库
const COMMON_TYPOS = [
  { wrong: '订金', right: '定金', context: '法律上“定金”具有担保性质，而“订金”通常视为预付款。' },
  { wrong: '权力', right: '权利', context: '合同中通常指民事“权利”（Rights），而非政治/行政“权力”（Power）。' },
  { wrong: '截止', right: '截至', context: '“截止”通常指过程结束，强调时间点；“截至”强调统计的时间段。' },
  { wrong: '其它', right: '其他', context: '正式文书中，指人或事物通常统一用“其他”。' },
  { wrong: '帐号', right: '账号', context: '规范用语应为“账号”。' },
  { wrong: '签定', right: '签订', context: '签署合同应使用“签订”。' },
];

// 关键条款检查列表
const ESSENTIAL_CLAUSES = [
  { keyword: ['不可抗力', '自然灾害'], name: '不可抗力条款', suggestion: '缺失不可抗力条款可能导致在遇到天灾人祸时无法免责，建议补充。' },
  { keyword: ['争议', '仲裁', '法院', '管辖'], name: '争议解决条款', suggestion: '未明确争议解决方式（仲裁或法院管辖地），发生纠纷时可能产生管辖权异议。' },
  { keyword: ['保密', '泄露'], name: '保密条款', suggestion: '建议增加保密义务及违约责任，保护商业机密。' },
  { keyword: ['违约责任', '赔偿'], name: '违约责任条款', suggestion: '必须明确违约后的具体赔偿计算方式或定额违约金。' },
];

const ContractAuditorPDF = () => {
  const [contractText, setContractText] = useState('');
  const [fileName, setFileName] = useState('');
  const [fileType, setFileType] = useState(''); // pdf, word, txt
  const [expectedAmount, setExpectedAmount] = useState('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [activeTab, setActiveTab] = useState('summary');
  const [results, setResults] = useState(null);

  // 载入示例文本
  const loadSample = () => {
    const sample = `
合同编号：2023-BJ-001

甲方（委托方）：未来科技有限公司
乙方（受托方）：先锋建设集团

一、项目概况
甲乙双方本着友好协商的原则，就软件园三期工程项目签定本协议。

二、合同金额
本合同总金额为人民币500,000元（大写：伍拾万元整）。
乙方需在收到预付款后3日内开工。
订金为总金额的20%，即100,000元。

三、双方权力与义务
1. 甲方有权监督施工进度。
2. 乙方需保证工程质量符合国家标准。
3. 任何一方违约，需赔偿对方损失。

四、其它事项
本合同一式两份，双方签字生效。
截止2023年12月31日完工。
    `;
    setContractText(sample.trim());
    setFileName('示例合同_软件园项目.pdf');
    setFileType('pdf');
    setExpectedAmount('500000');
    setResults(null);
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      setFileName(file.name);
      
      // 简单的类型判断用于图标展示
      if(file.name.endsWith('.pdf')) setFileType('pdf');
      else if(file.name.match(/\.(doc|docx)$/)) setFileType('word');
      else setFileType('txt');

      if (file.type === 'text/plain') {
        const reader = new FileReader();
        reader.onload = (e) => setContractText(e.target.result);
        reader.readAsText(file);
      } else {
        // 模拟 PDF/Word 解析过程
        setContractText("【系统提示】正在尝试解析 PDF/Word 文档...\n\n(注：此为纯前端演示环境，无法直接在浏览器中完美提取复杂 PDF 内容。)\n\n请点击右上角“载入测试样本”查看功能演示，或直接将合同文本粘贴至此。");
      }
      setResults(null);
    }
  };

  const runAnalysis = () => {
    if (!contractText || contractText.includes("【系统提示】")) {
        // 如果是提示文本，不做分析
        if(!contractText) return;
        // 如果用户没粘贴内容，只显示了提示，我们可以模拟加载样本
        if(contractText.includes("【系统提示】")) {
             loadSample(); 
             // 自动开始分析样本
             setTimeout(() => performAnalysis(), 500);
             return;
        }
    }
    performAnalysis();
  };

  const performAnalysis = () => {
    setIsAnalyzing(true);
    // 模拟分析耗时
    setTimeout(() => {
      // 1. 错别字检查
      const typosFound = [];
      COMMON_TYPOS.forEach(item => {
        const regex = new RegExp(item.wrong, 'g');
        let match;
        while ((match = regex.exec(contractText)) !== null) {
          typosFound.push({
            ...item,
            index: match.index,
            contextSnippet: contractText.substring(Math.max(0, match.index - 5), Math.min(contractText.length, match.index + 5))
          });
        }
      });

      // 2. 金额核对
      const moneyMatches = [];
      const digitRegex = /[\d,]+(\.\d+)?(?=\s*元)/g;
      
      let m;
      while ((m = digitRegex.exec(contractText)) !== null) {
        const val = parseFloat(m[0].replace(/,/g, ''));
        moneyMatches.push({ raw: m[0], value: val, type: 'digit', index: m.index });
      }

      // 3. 条款优化
      const missingClauses = [];
      ESSENTIAL_CLAUSES.forEach(clause => {
        const hasKeyword = clause.keyword.some(k => contractText.includes(k));
        if (!hasKeyword) {
          missingClauses.push(clause);
        }
      });

      setResults({
        typos: typosFound,
        money: moneyMatches,
        optimization: missingClauses,
        score: Math.max(0, 100 - (typosFound.length * 5) - (missingClauses.length * 10))
      });
      setIsAnalyzing(false);
      setActiveTab('summary');
    }, 1500);
  }

  const getAmountStatus = () => {
    if (!results || !expectedAmount) return { status: 'neutral', msg: '未输入预期金额' };
    const exp = parseFloat(expectedAmount);
    const hasMatch = results.money.some(m => Math.abs(m.value - exp) < 0.01);
    if (hasMatch) return { status: 'success', msg: '金额核对一致' };
    return { status: 'danger', msg: '未匹配到该金额' };
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans selection:bg-indigo-100">
      {/* 顶部导航 */}
      <header className="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="bg-indigo-600 text-white p-2 rounded-lg shadow-sm">
              <FileCheck size={24} />
            </div>
            <div>
              <h1 className="text-xl font-bold text-slate-900 tracking-tight leading-none">合同卫士</h1>
              <p className="text-[10px] text-slate-500 uppercase tracking-wider font-semibold mt-0.5">智能纠错与合规审查</p>
            </div>
          </div>
          <div className="flex space-x-4">
             <button onClick={loadSample} className="text-sm bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-md font-medium hover:bg-indigo-100 flex items-center transition-colors">
               <Sparkles size={16} className="mr-1.5" /> 载入 PDF 样本
             </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
          {/* 左侧：输入与上传区域 */}
          <div className="lg:col-span-7 flex flex-col space-y-6">
            
            {/* 上传卡片 */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-1 overflow-hidden">
               <div className="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                  <h2 className="text-base font-bold text-slate-700 flex items-center">
                    <Upload className="mr-2 text-indigo-500" size={18} /> 
                    文档导入
                  </h2>
                  {fileName && (
                    <div className="flex items-center bg-white px-2 py-1 rounded border border-slate-200 shadow-sm">
                      {fileType === 'pdf' ? (
                        <div className="w-5 h-5 bg-red-500 text-white text-[8px] flex items-center justify-center rounded mr-2 font-bold">PDF</div>
                      ) : fileType === 'word' ? (
                        <div className="w-5 h-5 bg-blue-500 text-white text-[8px] flex items-center justify-center rounded mr-2 font-bold">DOC</div>
                      ) : (
                        <FileText size={16} className="text-slate-400 mr-2" />
                      )}
                      <span className="text-xs font-medium text-slate-600 truncate max-w-[150px]">{fileName}</span>
                    </div>
                  )}
               </div>

               <div className="p-5">
                  <div className="relative group">
                    <textarea
                      className="w-full h-80 p-4 border border-slate-200 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all font-mono text-sm leading-relaxed resize-none text-slate-600"
                      placeholder="支持拖拽 PDF、Word 文档到此处，或直接粘贴合同文本..."
                      value={contractText}
                      onChange={(e) => setContractText(e.target.value)}
                    />
                    
                    {/* 空状态下的提示覆盖层 */}
                    {!contractText && (
                      <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                         <div className="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                           <Upload size={28} className="text-indigo-400" />
                         </div>
                         <p className="text-slate-500 font-medium">点击上传或拖拽文件</p>
                         <p className="text-xs text-slate-400 mt-1">支持 PDF, Word (.docx), TXT</p>
                      </div>
                    )}

                    {/* 实际的文件输入控件 */}
                    <input 
                      type="file" 
                      className={`absolute inset-0 w-full h-full opacity-0 cursor-pointer ${contractText ? 'hidden' : 'block'}`}
                      onChange={handleFileUpload}
                      accept=".txt,.doc,.docx,.pdf"
                    />
                  </div>

                  {/* 底部工具栏 */}
                  <div className="mt-4 flex items-center justify-between">
                     <div className="relative">
                        <button className="text-xs font-medium text-slate-500 hover:text-indigo-600 flex items-center transition-colors">
                          <File className="mr-1" size={14} /> 选择本地文件
                        </button>
                        <input 
                          type="file" 
                          className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                          onChange={handleFileUpload}
                          accept=".txt,.doc,.docx,.pdf"
                        />
                     </div>
                     <div className="text-[10px] text-slate-400">
                        单文件最大支持 20MB
                     </div>
                  </div>
               </div>
            </div>

            {/* 参数设定 */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <h2 className="text-base font-bold text-slate-700 mb-4 flex items-center">
                <CheckCircle className="mr-2 text-indigo-500" size={18} /> 
                校验规则设置
              </h2>
              <div className="flex items-end gap-4">
                <div className="flex-1">
                  <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">预期合同总金额</label>
                  <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <span className="text-slate-400 font-serif">¥</span>
                    </div>
                    <input
                      type="number"
                      value={expectedAmount}
                      onChange={(e) => setExpectedAmount(e.target.value)}
                      className="pl-8 block w-full rounded-lg border-slate-300 border py-2.5 px-3 focus:ring-indigo-500 focus:border-indigo-500 text-sm font-medium"
                      placeholder="例如：500000"
                    />
                  </div>
                </div>
                <button
                  onClick={runAnalysis}
                  disabled={isAnalyzing}
                  className={`px-6 py-2.5 rounded-lg text-white font-medium shadow-md shadow-indigo-200 transition-all flex items-center justify-center min-w-[140px]
                    ${isAnalyzing 
                      ? 'bg-indigo-400 cursor-not-allowed' 
                      : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-lg transform hover:-translate-y-0.5'
                    }
                  `}
                >
                  {isAnalyzing ? (
                    <>
                      <RefreshCw className="animate-spin mr-2 h-4 w-4" /> 扫描中...
                    </>
                  ) : (
                    <>
                      <Search className="mr-2 h-4 w-4" /> 开始审查
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>

          {/* 右侧：结果面板 */}
          <div className="lg:col-span-5 h-full min-h-[500px]">
            <div className="bg-white rounded-xl shadow-lg border border-slate-200 h-full overflow-hidden flex flex-col relative">
              
              {!results ? (
                // 空状态
                <div className="absolute inset-0 flex flex-col items-center justify-center p-8 text-center">
                  <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-6 border border-slate-100">
                    <ShieldAlert size={40} className="text-slate-300" />
                  </div>
                  <h3 className="text-lg font-bold text-slate-800 mb-2">等待文档</h3>
                  <p className="text-sm text-slate-500 max-w-[200px] leading-relaxed">
                    请在左侧上传 <strong>PDF/Word</strong> 合同文档，系统将自动进行三维合规性检查。
                  </p>
                </div>
              ) : (
                // 结果内容
                <div className="flex flex-col h-full animate-in fade-in duration-500">
                  {/* 头部评分卡 */}
                  <div className="p-6 bg-gradient-to-br from-slate-50 to-white border-b border-slate-100">
                    <div className="flex justify-between items-end mb-4">
                       <div>
                          <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">综合健康指数</p>
                          <div className={`text-4xl font-black ${results.score >= 90 ? 'text-emerald-500' : results.score >= 60 ? 'text-amber-500' : 'text-rose-500'}`}>
                            {results.score}
                          </div>
                       </div>
                       <div className="text-right">
                          <p className="text-xs text-slate-500 mb-1">发现问题</p>
                          <p className="text-lg font-bold text-slate-800">
                            {results.typos.length + results.optimization.length + (getAmountStatus().status === 'success' ? 0 : 1)} <span className="text-xs font-normal text-slate-400">项</span>
                          </p>
                       </div>
                    </div>
                    {/* 进度条 */}
                    <div className="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                      <div 
                        className={`h-full rounded-full transition-all duration-1000 ease-out ${results.score >= 90 ? 'bg-emerald-500' : results.score >= 60 ? 'bg-amber-500' : 'bg-rose-500'}`} 
                        style={{ width: `${results.score}%` }}
                      ></div>
                    </div>
                  </div>

                  {/* 导航 Tab */}
                  <div className="flex border-b border-slate-200 bg-white">
                    {[
                      { id: 'summary', label: '总览', icon: FileCheck },
                      { id: 'typos', label: '纠错', count: results.typos.length, icon: AlertTriangle },
                      { id: 'amount', label: '金额', icon: DollarSign, alert: getAmountStatus().status !== 'success' },
                      { id: 'optimize', label: '优化', count: results.optimization.length, icon: Sparkles },
                    ].map(tab => (
                      <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`flex-1 py-3 text-[13px] font-bold flex items-center justify-center border-b-[3px] transition-all
                          ${activeTab === tab.id ? 'border-indigo-500 text-indigo-600 bg-indigo-50/30' : 'border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50'}
                        `}
                      >
                        <tab.icon size={15} className={`mr-1.5 ${tab.alert ? 'text-rose-500' : ''}`} />
                        {tab.label}
                        {tab.count > 0 && (
                          <span className="ml-1.5 bg-rose-100 text-rose-600 text-[10px] px-1.5 py-0.5 rounded-full min-w-[1.2rem] text-center">
                            {tab.count}
                          </span>
                        )}
                      </button>
                    ))}
                  </div>

                  {/* 滚动内容区域 */}
                  <div className="flex-1 overflow-y-auto p-5 bg-slate-50/50 scroll-smooth">
                    
                    {/* 1. 总览视图 */}
                    {activeTab === 'summary' && (
                      <div className="space-y-3">
                        {/* 金额卡片 */}
                        <div className={`p-4 rounded-xl border ${getAmountStatus().status === 'success' ? 'bg-emerald-50/50 border-emerald-100' : 'bg-rose-50/50 border-rose-100'}`}>
                           <div className="flex items-center mb-2">
                             <div className={`p-1.5 rounded-md mr-3 ${getAmountStatus().status === 'success' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>
                               <DollarSign size={16} />
                             </div>
                             <h4 className={`font-bold text-sm ${getAmountStatus().status === 'success' ? 'text-emerald-800' : 'text-rose-800'}`}>
                               {getAmountStatus().msg}
                             </h4>
                           </div>
                           <p className="text-xs text-slate-600 ml-10">
                             {getAmountStatus().status === 'success' 
                               ? `文档金额与预期的 ¥${parseFloat(expectedAmount).toLocaleString()} 一致。` 
                               : `文档中未找到与预期 ¥${parseFloat(expectedAmount).toLocaleString()} 完全匹配的数字。`
                             }
                           </p>
                        </div>

                        {/* 统计列表 */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                          <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3">详细扫描结果</h4>
                          <div className="space-y-3">
                            <div className="flex justify-between items-center text-sm border-b border-slate-50 pb-2">
                              <span className="text-slate-600">文字规范性</span>
                              {results.typos.length === 0 ? (
                                <span className="text-emerald-500 font-medium flex items-center"><CheckCircle size={14} className="mr-1"/> 合格</span>
                              ) : (
                                <span className="text-rose-500 font-medium">{results.typos.length} 处错误</span>
                              )}
                            </div>
                            <div className="flex justify-between items-center text-sm">
                              <span className="text-slate-600">条款完整性</span>
                              {results.optimization.length === 0 ? (
                                <span className="text-emerald-500 font-medium flex items-center"><CheckCircle size={14} className="mr-1"/> 完备</span>
                              ) : (
                                <span className="text-amber-500 font-medium">{results.optimization.length} 项建议</span>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* 2. 纠错视图 */}
                    {activeTab === 'typos' && (
                      <div className="space-y-3">
                        {results.typos.length === 0 ? (
                          <div className="text-center py-12">
                             <div className="inline-block p-3 rounded-full bg-emerald-100 text-emerald-500 mb-3">
                               <CheckCircle size={24} />
                             </div>
                             <p className="text-sm text-slate-500">文书规范，未发现常见错别字</p>
                          </div>
                        ) : (
                          results.typos.map((item, idx) => (
                            <div key={idx} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                              <div className="flex items-center justify-between mb-3">
                                <div className="flex items-center space-x-2">
                                  <span className="px-2 py-1 bg-rose-50 text-rose-600 text-xs rounded border border-rose-100 line-through decoration-rose-400 decoration-2">{item.wrong}</span>
                                  <ChevronRight size={14} className="text-slate-300" />
                                  <span className="px-2 py-1 bg-emerald-50 text-emerald-600 text-xs rounded border border-emerald-100 font-bold">{item.right}</span>
                                </div>
                                <span className="text-[10px] text-slate-400 font-mono">Ln {Math.floor(item.index / 20) + 1}</span>
                              </div>
                              <div className="bg-slate-50 p-2.5 rounded-lg mb-2">
                                <p className="text-xs text-slate-600 font-mono leading-relaxed">
                                  ...{item.contextSnippet}...
                                </p>
                              </div>
                              <p className="text-[11px] text-slate-500 flex items-start">
                                <AlertTriangle size={12} className="mr-1.5 mt-0.5 text-amber-400 flex-shrink-0" />
                                {item.context}
                              </p>
                            </div>
                          ))
                        )}
                      </div>
                    )}

                    {/* 3. 金额视图 */}
                    {activeTab === 'amount' && (
                      <div className="space-y-4">
                        <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                           <div className="bg-slate-50 px-4 py-2 border-b border-slate-200 flex justify-between items-center">
                              <span className="text-xs font-bold text-slate-500">文档内提取的数字</span>
                              <span className="text-[10px] text-slate-400">自动 OCR 识别</span>
                           </div>
                           {results.money.length === 0 ? (
                              <div className="p-6 text-center text-slate-400 text-sm">未提取到有效金额</div>
                           ) : (
                              <div className="divide-y divide-slate-100">
                                {results.money.map((m, idx) => {
                                  const isMatch = expectedAmount && Math.abs(m.value - parseFloat(expectedAmount)) < 0.01;
                                  return (
                                    <div key={idx} className={`p-4 flex justify-between items-center ${isMatch ? 'bg-emerald-50/30' : 'hover:bg-slate-50'}`}>
                                      <div>
                                        <div className="text-sm font-mono text-slate-700 font-medium">{m.raw}</div>
                                        <div className="text-[10px] text-slate-400 mt-0.5">位置: 第 {idx + 1} 处出现</div>
                                      </div>
                                      {isMatch && (
                                        <span className="flex items-center text-xs text-emerald-600 font-medium bg-emerald-100 px-2 py-1 rounded-full">
                                          <CheckCircle size={12} className="mr-1" /> 匹配
                                        </span>
                                      )}
                                    </div>
                                  )
                                })}
                              </div>
                           )}
                        </div>
                      </div>
                    )}

                    {/* 4. 优化视图 */}
                    {activeTab === 'optimize' && (
                      <div className="space-y-3">
                        {results.optimization.length === 0 ? (
                          <div className="text-center py-12">
                             <div className="inline-block p-3 rounded-full bg-emerald-100 text-emerald-500 mb-3">
                               <Sparkles size={24} />
                             </div>
                             <p className="text-sm text-slate-500">合同关键条款完备</p>
                          </div>
                        ) : (
                          results.optimization.map((item, idx) => (
                            <div key={idx} className="bg-white p-4 rounded-xl border-l-[3px] border-amber-400 shadow-sm border-y border-r border-slate-200">
                              <div className="flex justify-between items-start mb-2">
                                <h5 className="font-bold text-slate-800 text-sm flex items-center">
                                  <ShieldAlert size={14} className="mr-2 text-amber-500" />
                                  建议补充：{item.name}
                                </h5>
                              </div>
                              <p className="text-xs text-slate-600 leading-relaxed mb-3">
                                {item.suggestion}
                              </p>
                              <div className="flex flex-wrap gap-2">
                                {item.keyword.map(k => (
                                  <span key={k} className="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded border border-slate-200">
                                    缺关键词: {k}
                                  </span>
                                ))}
                              </div>
                            </div>
                          ))
                        )}
                      </div>
                    )}

                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </main>
    </div>
  );
};

export default ContractAuditorPDF;
