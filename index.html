import React, { useState, useEffect, useMemo } from 'react';
import { 
  FileText, 
  Upload, 
  Search, 
  DollarSign, 
  Sparkles, 
  AlertTriangle, 
  CheckCircle, 
  XCircle, 
  ArrowRight,
  RefreshCw,
  FileSearch
} from 'lucide-react';

// -----------------------------------------------------------------------------
// 模拟算法与辅助函数 (Simulated Algorithms & Helpers)
// -----------------------------------------------------------------------------

// 模拟错别字/敏感词库
const TYPO_DATABASE = [
  { pattern: /的的/g, suggestion: '的', type: '重复用词' },
  { pattern: /拟定/g, suggestion: '制定', type: '用词不当' },
  { pattern: /权力/g, context: '义务', suggestion: '权利', type: '法律用词错误' }, // 当上下文有"义务"时，应该是"权利"
  { pattern: /订金/g, suggestion: '定金', type: '法律风险' }, // 订金与定金的区别
  { pattern: /截止/g, suggestion: '截至', type: '时间用词' },
];

// 模拟合同优化规则
const OPTIMIZATION_RULES = [
  { keyword: '不可抗力', required: true, message: '未检测到“不可抗力”条款，建议补充以规避意外风险。' },
  { keyword: '违约责任', required: true, message: '合同中似乎缺少明确的“违约责任”界定，建议详细列出。' },
  { keyword: '争议解决', required: true, message: '建议明确“争议解决”方式（如仲裁或诉讼管辖地）。' },
  { keyword: '保密', required: false, message: '如果涉及商业机密，建议增加“保密条款”。' },
];

// 简单的金额提取正则 (支持 1000, 1,000.00, 100万)
const AMOUNT_REGEX = /([0-9]{1,3}(,[0-9]{3})*(\.[0-9]+)?|[0-9]+)(\s?)(元|万元|亿元)?/g;
// 中文大写金额简单匹配
const CN_AMOUNT_REGEX = /[零壹贰叁肆伍陆柒捌玖拾佰仟万亿]+圆?整?/g;

// 示例文本
const SAMPLE_CONTRACT = `
合同编号：2023-HT-001

甲方：未来科技有限公司
乙方：诚信服务有限公司

一、合作内容
甲乙双方本着平等互利的原则，经友好协商，就甲方委托乙方开发软件系统事宜达成如下协议。

二、合同金额
1. 本合同总金额为人民币 50,000.00元（大写：伍万元整）。
2. 甲方应于合同签订后支付预付款 20000元。
3. 项目验收合格后，支付尾款 30,000.00元。

三、双方权力与义务
1. 甲方拥有项目的知识产权。
2. 乙方需按时交付，不得延误。
3. 这里的的文字是多余的，用于测试重复字检测。
4. 乙方收取的订金不予退还。

四、其他
本合同有效期一年，截止2024年12月31日。
`;

// -----------------------------------------------------------------------------
// UI Components
// -----------------------------------------------------------------------------

const FeatureCard = ({ title, icon: Icon, active, onClick, description }) => (
  <div 
    onClick={onClick}
    className={`p-4 rounded-xl border cursor-pointer transition-all duration-200 flex flex-col gap-2 ${
      active 
        ? 'bg-blue-50 border-blue-500 shadow-md ring-1 ring-blue-500' 
        : 'bg-white border-gray-200 hover:border-blue-300 hover:shadow-sm'
    }`}
  >
    <div className="flex items-center justify-between">
      <div className={`p-2 rounded-lg ${active ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
        <Icon size={20} />
      </div>
      {active && <span className="text-xs font-bold text-blue-600 px-2 py-1 bg-blue-100 rounded-full">当前模式</span>}
    </div>
    <div>
      <h3 className={`font-bold ${active ? 'text-blue-900' : 'text-gray-800'}`}>{title}</h3>
      <p className="text-xs text-gray-500 mt-1 line-clamp-2">{description}</p>
    </div>
  </div>
);

const AlertBox = ({ type, title, children }) => {
  const styles = {
    warning: 'bg-orange-50 border-orange-200 text-orange-800 icon-orange-500',
    success: 'bg-green-50 border-green-200 text-green-800 icon-green-500',
    info: 'bg-blue-50 border-blue-200 text-blue-800 icon-blue-500',
    danger: 'bg-red-50 border-red-200 text-red-800 icon-red-500',
  };
  const currentStyle = styles[type] || styles.info;

  return (
    <div className={`p-4 rounded-lg border ${currentStyle} mb-3 text-sm`}>
      <div className="font-bold flex items-center gap-2 mb-1">
        {type === 'warning' && <AlertTriangle size={16} />}
        {type === 'success' && <CheckCircle size={16} />}
        {type === 'danger' && <XCircle size={16} />}
        {type === 'info' && <FileSearch size={16} />}
        {title}
      </div>
      <div className="opacity-90 leading-relaxed">{children}</div>
    </div>
  );
};

// -----------------------------------------------------------------------------
// Main Application Component
// -----------------------------------------------------------------------------

export default function App() {
  const [activeTab, setActiveTab] = useState('upload'); // upload, typo, amount, optimize
  const [fileName, setFileName] = useState('');
  const [content, setContent] = useState('');
  const [analysisResults, setAnalysisResults] = useState(null);
  const [targetAmount, setTargetAmount] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);

  // --- Handlers ---

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      setFileName(file.name);
      const reader = new FileReader();
      reader.onload = (event) => {
        setContent(event.target.result);
        setActiveTab('typo');
        runAnalysis(event.target.result);
      };
      reader.readAsText(file); // Demo assumes text file for simplicity
    }
  };

  const loadSample = () => {
    setFileName('演示合同_2023.txt');
    setContent(SAMPLE_CONTRACT);
    setActiveTab('typo');
    runAnalysis(SAMPLE_CONTRACT);
  };

  const runAnalysis = (text) => {
    setIsProcessing(true);
    // Simulate processing delay
    setTimeout(() => {
      // 1. Typo Analysis
      const typos = [];
      TYPO_DATABASE.forEach(rule => {
        let match;
        // Reset regex index
        if (rule.pattern.global) rule.pattern.lastIndex = 0;
        
        while ((match = rule.pattern.exec(text)) !== null) {
          // Context check (simple simulation)
          if (rule.context && !text.includes(rule.context)) continue;
          
          typos.push({
            id: Math.random().toString(36),
            text: match[0],
            suggestion: rule.suggestion,
            type: rule.type,
            index: match.index
          });
        }
      });

      // 2. Amount Extraction
      const amounts = [];
      let match;
      // Numeric
      const numRegex = new RegExp(AMOUNT_REGEX);
      while ((match = numRegex.exec(text)) !== null) {
        amounts.push({ 
            original: match[0], 
            value: parseFloat(match[0].replace(/,/g, '')), 
            type: '数字金额' 
        });
      }
      // Chinese
      const cnRegex = new RegExp(CN_AMOUNT_REGEX);
      while ((match = cnRegex.exec(text)) !== null) {
        amounts.push({ original: match[0], value: 0, type: '大写金额' }); // Parsing CN amount to number is complex, skipping for demo
      }

      // 3. Optimization
      const optimizations = [];
      OPTIMIZATION_RULES.forEach(rule => {
        if (!text.includes(rule.keyword)) {
          optimizations.push(rule);
        }
      });

      setAnalysisResults({ typos, amounts, optimizations });
      setIsProcessing(false);
    }, 800);
  };

  // --- Views ---

  const renderUploadView = () => (
    <div className="flex flex-col items-center justify-center h-full p-8 text-center bg-slate-50 rounded-xl border-2 border-dashed border-slate-300">
      <div className="bg-white p-6 rounded-full shadow-sm mb-6">
        <Upload size={48} className="text-blue-500" />
      </div>
      <h2 className="text-2xl font-bold text-slate-800 mb-2">上传合同文档</h2>
      <p className="text-slate-500 mb-8 max-w-md">
        支持 .txt 格式 (真实环境可扩展PDF/Word)。
        系统将自动进行错别字检查、金额核对及风险评估。
      </p>
      
      <div className="flex gap-4">
        <label className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg cursor-pointer font-medium transition-colors flex items-center gap-2">
          <FileText size={18} />
          选择文件
          <input type="file" className="hidden" accept=".txt" onChange={handleFileUpload} />
        </label>
        
        <button 
          onClick={loadSample}
          className="bg-white hover:bg-slate-100 text-slate-700 border border-slate-300 px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2"
        >
          <Sparkles size={18} />
          使用演示文本
        </button>
      </div>
    </div>
  );

  const renderTypoView = () => {
    if (!analysisResults) return null;
    const { typos } = analysisResults;

    return (
      <div className="space-y-6">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
            <Search className="text-blue-500" />
            错别字与风险词检测
            <span className="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full">{typos.length} 处问题</span>
          </h3>
          
          {typos.length === 0 ? (
            <AlertBox type="success" title="完美">未检测到明显的错别字或禁用词。</AlertBox>
          ) : (
            <div className="grid gap-3">
              {typos.map((item, idx) => (
                <div key={idx} className="flex items-start justify-between p-3 bg-red-50 border border-red-100 rounded-lg">
                  <div>
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-red-700 font-bold line-through decoration-red-400">{item.text}</span>
                      <ArrowRight size={14} className="text-gray-400" />
                      <span className="text-green-700 font-bold">{item.suggestion}</span>
                    </div>
                    <p className="text-xs text-red-500">类型：{item.type}</p>
                  </div>
                  <button className="text-xs bg-white border border-gray-200 hover:bg-gray-50 px-3 py-1 rounded text-gray-600">
                    定位
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
        
        <div className="bg-slate-50 p-4 rounded-lg text-sm text-slate-500">
          <p>提示：系统主要检测常见的法律文书易错字（如“订金/定金”、“截止/截至”）、重复录入及格式错误。</p>
        </div>
      </div>
    );
  };

  const renderAmountView = () => {
    if (!analysisResults) return null;
    const { amounts } = analysisResults;

    // Logic to check if target amount exists in found amounts
    const targetVal = parseFloat(targetAmount) || 0;
    const matchFound = amounts.some(a => a.value === targetVal);
    const hasAmounts = amounts.length > 0;

    return (
      <div className="space-y-6">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
            <DollarSign className="text-green-500" />
            金额智能核对
          </h3>

          <div className="mb-6">
             <label className="block text-sm font-medium text-gray-700 mb-2">输入预期合同总金额（数字）：</label>
             <div className="flex gap-2">
               <input 
                 type="number" 
                 value={targetAmount}
                 onChange={(e) => setTargetAmount(e.target.value)}
                 placeholder="例如：50000"
                 className="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
               />
               <button className="bg-blue-600 text-white px-4 rounded-lg font-medium">核对</button>
             </div>
          </div>

          {targetAmount && (
             matchFound ? (
                <AlertBox type="success" title="金额匹配成功">
                   在文档中找到了与 {targetAmount} 匹配的金额款项。
                </AlertBox>
             ) : (
                <AlertBox type="warning" title="金额存在风险">
                   文档中似乎没有找到与 {targetAmount} 完全匹配的数字金额，请仔细核对大小写或分期付款项。
                </AlertBox>
             )
          )}

          <div className="mt-6">
            <h4 className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">文中识别到的金额</h4>
            {hasAmounts ? (
              <div className="space-y-2">
                {amounts.map((amt, idx) => (
                  <div key={idx} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <span className="font-mono text-gray-800 font-medium">{amt.original}</span>
                    <span className="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">{amt.type}</span>
                  </div>
                ))}
              </div>
            ) : (
               <p className="text-gray-400 italic text-sm">文档中未识别到明确的金额数字。</p>
            )}
          </div>
        </div>
      </div>
    );
  };

  const renderOptimizeView = () => {
    if (!analysisResults) return null;
    const { optimizations } = analysisResults;

    return (
      <div className="space-y-6">
         <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
            <Sparkles className="text-purple-500" />
            合同内容优化建议
          </h3>
          
          <div className="grid gap-4">
            {optimizations.length === 0 ? (
               <AlertBox type="success" title="结构完整">常用关键条款（如不可抗力、违约责任等）均已检测到。</AlertBox>
            ) : (
              optimizations.map((opt, idx) => (
                <AlertBox key={idx} type="warning" title={`缺失：${opt.keyword}`}>
                   {opt.message}
                </AlertBox>
              ))
            )}
            
            <div className="p-4 bg-purple-50 rounded-lg border border-purple-100 mt-4">
               <h4 className="font-bold text-purple-900 mb-2">通用优化建议</h4>
               <ul className="list-disc list-inside text-sm text-purple-800 space-y-1">
                 <li>建议检查合同签署日期是否明确。</li>
                 <li>如果是跨地区合作，建议明确管辖法院。</li>
                 <li>注意检查“附件”是否齐全。</li>
               </ul>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderActiveView = () => {
     if (isProcessing) {
       return (
         <div className="h-full flex flex-col items-center justify-center text-gray-500">
           <RefreshCw className="animate-spin mb-4 text-blue-500" size={32} />
           <p>智能分析引擎正在扫描文档...</p>
         </div>
       );
     }
     
     switch(activeTab) {
       case 'upload': return renderUploadView();
       case 'typo': return renderTypoView();
       case 'amount': return renderAmountView();
       case 'optimize': return renderOptimizeView();
       default: return renderUploadView();
     }
  };

  // ---------------------------------------------------------------------------
  // Main Layout Render
  // ---------------------------------------------------------------------------
  
  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans flex flex-col">
      {/* Header */}
      <header className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
        <div className="flex items-center gap-3">
          <div className="bg-blue-600 p-2 rounded-lg text-white">
            <FileSearch size={24} />
          </div>
          <h1 className="text-xl font-bold tracking-tight text-slate-800">合同卫士 <span className="text-xs font-normal text-slate-500 ml-2">智能自查系统</span></h1>
        </div>
        
        {fileName && (
          <div className="flex items-center gap-4">
            <div className="text-sm px-3 py-1 bg-slate-100 rounded-full text-slate-600 border border-slate-200">
              当前文件: <span className="font-semibold text-slate-900">{fileName}</span>
            </div>
            <button 
               onClick={() => { setFileName(''); setContent(''); setActiveTab('upload'); setAnalysisResults(null); }}
               className="text-sm text-red-500 hover:text-red-700 font-medium"
            >
              重新上传
            </button>
          </div>
        )}
      </header>

      {/* Main Container */}
      <main className="flex-1 max-w-7xl mx-auto w-full p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        {/* Left Sidebar / Navigation (Only visible when file is loaded) */}
        {fileName && (
          <aside className="lg:col-span-4 space-y-4">
            <div className="sticky top-24 space-y-4">
              <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wider px-1">核心功能</h2>
              <FeatureCard 
                title="错别字纠察" 
                description="识别重复字、敏感词及法律用语错误"
                icon={Search} 
                active={activeTab === 'typo'}
                onClick={() => setActiveTab('typo')}
              />
              <FeatureCard 
                title="金额核对" 
                description="提取文中金额与预期总额比对"
                icon={DollarSign} 
                active={activeTab === 'amount'}
                onClick={() => setActiveTab('amount')}
              />
              <FeatureCard 
                title="合同优化" 
                description="基于条款完整性的智能建议"
                icon={Sparkles} 
                active={activeTab === 'optimize'}
                onClick={() => setActiveTab('optimize')}
              />
              
              <div className="pt-4 border-t border-slate-200 mt-6">
                <h3 className="text-sm font-bold text-slate-800 mb-2">文档预览</h3>
                <div className="bg-white border border-slate-200 rounded-lg p-3 h-64 overflow-y-auto text-xs text-slate-600 font-mono whitespace-pre-wrap leading-relaxed">
                  {content}
                </div>
              </div>
            </div>
          </aside>
        )}

        {/* Right Content Area */}
        <section className={`${fileName ? 'lg:col-span-8' : 'lg:col-span-12'}`}>
          <div className="bg-white min-h-[500px] rounded-2xl shadow-sm border border-slate-200 p-6">
             {renderActiveView()}
          </div>
        </section>

      </main>
    </div>
  );
}
