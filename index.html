<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合同卫士 Pro (修复版)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js (v3.11.174) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Mammoth.js (v1.6.0) 用于 Word -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <!-- React & Lucide -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            FileText, Upload, Search, DollarSign, Sparkles, 
            AlertTriangle, CheckCircle, XCircle, ArrowRight, 
            RefreshCw, FileSearch, ShieldCheck, FileType, AlertCircle
        } from 'lucide-react';

        // --- 初始化配置 ---
        // 确保 PDF Worker 指向正确的 CDN 地址
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // --- 核心解析逻辑 (增强健壮性) ---

        const readPdfFile = async (file) => {
            if (!window.pdfjsLib) throw new Error("PDF解析组件未加载，请检查网络连接");
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                // 关键修复: 将 ArrayBuffer 转换为 Uint8Array，这是 pdf.js 推荐的方式
                const uint8Array = new Uint8Array(arrayBuffer);
                const loadingTask = window.pdfjsLib.getDocument({ data: uint8Array });
                const pdf = await loadingTask.promise;
                
                let fullText = '';
                const totalPages = pdf.numPages;

                // 限制最大页数以防止浏览器崩溃 (例如最大 50 页)
                const maxPages = Math.min(totalPages, 50);

                for (let i = 1; i <= maxPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    // 添加空格以保留一些格式
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `[第${i}页] ` + pageText + '\n\n';
                }
                
                if (totalPages > maxPages) {
                    fullText += `\n[系统提示] 文档过长，仅分析了前 ${maxPages} 页...\n`;
                }

                return fullText;
            } catch (err) {
                console.error("PDF Read Error:", err);
                throw new Error("PDF解析失败: 可能是加密文档或纯图片扫描件");
            }
        };

        const readWordFile = async (file) => {
            if (!window.mammoth) throw new Error("Word解析组件未加载，请检查网络连接");
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await window.mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                if (result.messages && result.messages.length > 0) {
                    console.log("Mammoth messages:", result.messages);
                }
                return result.value;
            } catch (err) {
                console.error("Word Read Error:", err);
                throw new Error("Word解析失败: 请确保文件未损坏且为 .docx 格式");
            }
        };

        const readTextFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error("读取文本文件失败"));
                reader.readAsText(file);
            });
        };

        // --- 模拟算法数据 ---
        
        const TYPO_DATABASE = [
            { pattern: /的的/g, suggestion: '的', type: '重复用词' },
            { pattern: /拟定/g, suggestion: '制定', type: '用词不当' },
            { pattern: /权力/g, context: '义务', suggestion: '权利', type: '法律用词错误' },
            { pattern: /订金/g, suggestion: '定金', type: '法律风险' },
            { pattern: /截止/g, suggestion: '截至', type: '时间用词' },
            { pattern: /帐号/g, suggestion: '账号', type: '规范用词' },
        ];

        const OPTIMIZATION_RULES = [
            { keyword: '不可抗力', required: true, message: '未检测到“不可抗力”条款，建议补充以规避意外风险。' },
            { keyword: '违约责任', required: true, message: '合同中缺少明确的“违约责任”界定，建议详细列出。' },
            { keyword: '争议解决', required: true, message: '建议明确“争议解决”方式（如仲裁或诉讼管辖地）。' },
            { keyword: '生效', required: true, message: '未找到“生效条件”，请检查是否明确了合同何时生效。' },
        ];

        const AMOUNT_REGEX = /([0-9]{1,3}(,[0-9]{3})*(\.[0-9]+)?|[0-9]+)(\s?)(元|万元|亿元)?/g;
        const CN_AMOUNT_REGEX = /[零壹贰叁肆伍陆柒捌玖拾佰仟万亿]+圆?整?/g;

        // --- UI 组件 ---

        const AlertBox = ({ type, title, children }) => {
            const styles = {
                warning: 'bg-orange-50 border-orange-200 text-orange-800',
                success: 'bg-green-50 border-green-200 text-green-800',
                info: 'bg-blue-50 border-blue-200 text-blue-800',
                danger: 'bg-red-50 border-red-200 text-red-800',
            };
            const icons = {
                warning: AlertTriangle,
                success: CheckCircle,
                info: FileSearch,
                danger: XCircle
            };
            const Icon = icons[type] || FileSearch;
            return (
                <div className={`p-4 rounded-lg border ${styles[type] || styles.info} mb-3 text-sm animate-fade-in`}>
                    <div className="font-bold flex items-center gap-2 mb-1">
                        <Icon size={16} />
                        {title}
                    </div>
                    <div className="opacity-90 leading-relaxed ml-6">{children}</div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('upload'); 
            const [fileName, setFileName] = useState('');
            const [fileType, setFileType] = useState('');
            const [content, setContent] = useState('');
            const [analysisResults, setAnalysisResults] = useState(null);
            const [targetAmount, setTargetAmount] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [processStatus, setProcessStatus] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            
            const fileInputRef = useRef(null);

            // 检查外部库加载状态
            useEffect(() => {
                if (!window.pdfjsLib) console.warn("PDF.js 尚未加载完成");
                if (!window.mammoth) console.warn("Mammoth.js 尚未加载完成");
            }, []);

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // 重置状态
                setFileName(file.name);
                setIsProcessing(true);
                setErrorMsg('');
                setAnalysisResults(null);
                setProcessStatus('正在初始化读取器...');

                try {
                    let text = '';
                    const lowerName = file.name.toLowerCase();

                    if (lowerName.endsWith('.pdf')) {
                        setProcessStatus('正在深度解析 PDF 结构 (可能需要几秒)...');
                        setFileType('PDF');
                        text = await readPdfFile(file);
                    } else if (lowerName.endsWith('.docx') || lowerName.endsWith('.doc')) {
                        if (lowerName.endsWith('.doc')) {
                             throw new Error("暂不支持旧版 .doc 格式，请另存为 .docx 后上传");
                        }
                        setProcessStatus('正在提取 Word 文档内容...');
                        setFileType('Word');
                        text = await readWordFile(file);
                    } else if (lowerName.endsWith('.txt')) {
                        setProcessStatus('正在读取文本...');
                        setFileType('TXT');
                        text = await readTextFile(file);
                    } else {
                        throw new Error("不支持的文件格式。请上传 PDF, Word(.docx) 或 Txt");
                    }

                    if (!text || text.trim().length < 5) {
                        throw new Error("无法提取有效文本。如果是 PDF，请确保不是纯图片扫描件。");
                    }

                    setContent(text);
                    setProcessStatus('正在进行 AI 规则分析...');
                    
                    // 模拟分析耗时，提升体验
                    setTimeout(() => {
                        runAnalysis(text);
                        setActiveTab('typo');
                    }, 600);

                } catch (error) {
                    console.error("Main Process Error:", error);
                    setErrorMsg(error.message || "文件解析发生未知错误");
                    setFileName('');
                    setIsProcessing(false);
                } finally {
                    // 清空 input，允许重复上传同一文件
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };

            const runAnalysis = (text) => {
                // 1. 错别字
                const typos = [];
                TYPO_DATABASE.forEach(rule => {
                    let match;
                    if (rule.pattern.global) rule.pattern.lastIndex = 0;
                    while ((match = rule.pattern.exec(text)) !== null) {
                        if (rule.context && !text.includes(rule.context)) continue;
                        typos.push({
                            id: Math.random().toString(36),
                            text: match[0],
                            suggestion: rule.suggestion,
                            type: rule.type,
                            index: match.index
                        });
                    }
                });

                // 2. 金额
                const amounts = [];
                let match;
                const numRegex = new RegExp(AMOUNT_REGEX);
                while ((match = numRegex.exec(text)) !== null) {
                    // 过滤掉年份 (简单逻辑：如果看起来像年份 2023, 2024 等)
                    const val = parseFloat(match[0].replace(/,/g, ''));
                    if (val > 1990 && val < 2030 && !match[0].includes('.')) {
                        // 可能是年份，略过，除非有单位
                        if (!match[0].includes('元')) continue;
                    }
                    
                    amounts.push({ 
                        original: match[0], 
                        value: val, 
                        type: '数字金额' 
                    });
                }
                const cnRegex = new RegExp(CN_AMOUNT_REGEX);
                while ((match = cnRegex.exec(text)) !== null) {
                    amounts.push({ original: match[0], value: 0, type: '大写金额' });
                }

                // 3. 优化
                const optimizations = [];
                OPTIMIZATION_RULES.forEach(rule => {
                    if (!text.includes(rule.keyword)) {
                        optimizations.push(rule);
                    }
                });

                setAnalysisResults({ typos, amounts, optimizations });
                setIsProcessing(false);
            };

            // --- 视图 ---

            const renderUploadView = () => (
                <div className="flex flex-col items-center justify-center h-full min-h-[400px] p-8 text-center bg-slate-50/50 rounded-xl border-2 border-dashed border-slate-300 relative">
                    {errorMsg && (
                        <div className="absolute top-4 left-4 right-4 bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-2 animate-fade-in">
                            <XCircle size={20} />
                            <span className="font-medium text-sm text-left">{errorMsg}</span>
                        </div>
                    )}

                    <div className="bg-white p-6 rounded-full shadow-sm mb-6 animate-bounce">
                        <Upload size={48} className="text-blue-500" />
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">上传合同文档</h2>
                    <p className="text-slate-500 mb-8 max-w-md text-sm leading-relaxed">
                        支持 <span className="font-bold text-slate-700">PDF, Word (.docx), TXT</span>。<br/>
                        <span className="text-xs text-slate-400">注意：扫描版图片 PDF 无法提取文字。不支持旧版 .doc 格式。</span>
                    </p>
                    
                    <div className="flex gap-4">
                        <label className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg cursor-pointer font-medium transition-colors flex items-center justify-center gap-2 shadow-lg shadow-blue-200">
                            <FileText size={18} />
                            选择文件
                            <input 
                                ref={fileInputRef}
                                type="file" 
                                className="hidden" 
                                accept=".txt,text/plain,.pdf,application/pdf,.docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" 
                                onChange={handleFileChange} 
                            />
                        </label>
                    </div>
                </div>
            );

            const renderResultsView = () => {
                if (!analysisResults) return null;
                const { typos, amounts, optimizations } = analysisResults;
                
                const tabs = [
                    { id: 'typo', label: '错别字', icon: Search, count: typos.length, color: 'red' },
                    { id: 'amount', label: '金额', icon: DollarSign, count: amounts.length, color: 'green' },
                    { id: 'optimize', label: '优化', icon: Sparkles, count: optimizations.length, color: 'purple' },
                ];

                return (
                    <div className="h-full flex flex-col">
                        {/* Tab Header inside Content Area */}
                        <div className="flex border-b border-gray-100 mb-6">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex-1 py-3 text-sm font-medium border-b-2 transition-colors flex items-center justify-center gap-2 ${
                                        activeTab === tab.id 
                                        ? 'border-blue-500 text-blue-600' 
                                        : 'border-transparent text-gray-500 hover:text-gray-700'
                                    }`}
                                >
                                    <tab.icon size={16} />
                                    {tab.label}
                                    {tab.count > 0 && (
                                        <span className={`text-[10px] px-1.5 py-0.5 rounded-full bg-${tab.color}-100 text-${tab.color}-600`}>
                                            {tab.count}
                                        </span>
                                    )}
                                </button>
                            ))}
                        </div>

                        <div className="flex-1 overflow-y-auto pr-2">
                            {activeTab === 'typo' && (
                                <div className="space-y-3 animate-fade-in">
                                    {typos.length === 0 ? (
                                        <AlertBox type="success" title="完美">未检测到明显的错别字。</AlertBox>
                                    ) : (
                                        typos.map((item, idx) => (
                                            <div key={idx} className="flex justify-between items-center p-3 bg-red-50 border border-red-100 rounded-lg">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-red-700 font-bold line-through opacity-60">{item.text}</span>
                                                    <ArrowRight size={14} className="text-gray-400" />
                                                    <span className="text-green-700 font-bold">{item.suggestion}</span>
                                                </div>
                                                <span className="text-xs text-red-400 border border-red-100 px-2 py-1 rounded">{item.type}</span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}

                            {activeTab === 'amount' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">金额快速核对</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="number" 
                                                value={targetAmount}
                                                onChange={(e) => setTargetAmount(e.target.value)}
                                                placeholder="输入合同总额 (如: 50000)"
                                                className="flex-1 p-2 border border-gray-300 rounded focus:border-blue-500 outline-none text-sm"
                                            />
                                            {targetAmount && (
                                                <div className="flex items-center">
                                                    {amounts.some(a => a.value == targetAmount) 
                                                        ? <CheckCircle className="text-green-500" size={24} />
                                                        : <XCircle className="text-red-500" size={24} />
                                                    }
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="text-xs font-bold text-gray-400 uppercase mb-3">提取明细</h4>
                                        <div className="grid grid-cols-1 gap-2">
                                            {amounts.length > 0 ? amounts.map((amt, idx) => (
                                                <div key={idx} className="flex justify-between p-3 bg-white border border-gray-100 rounded hover:bg-slate-50">
                                                    <span className="font-mono text-gray-800">{amt.original}</span>
                                                    <span className="text-xs text-gray-400">{amt.type}</span>
                                                </div>
                                            )) : <p className="text-sm text-gray-400 text-center py-4">未提取到金额</p>}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'optimize' && (
                                <div className="space-y-3 animate-fade-in">
                                    {optimizations.length === 0 ? (
                                        <AlertBox type="success" title="条款完备">常用关键条款均已检测到。</AlertBox>
                                    ) : (
                                        optimizations.map((opt, idx) => (
                                            <AlertBox key={idx} type="warning" title={`缺失: ${opt.keyword}`}>
                                                {opt.message}
                                            </AlertBox>
                                        ))
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 flex flex-col">
                    <header className="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-5xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg text-white">
                                    <ShieldCheck size={24} />
                                </div>
                                <h1 className="text-xl font-bold text-slate-800">合同卫士 Pro</h1>
                            </div>
                            
                            {fileName && (
                                <button 
                                    onClick={() => { setFileName(''); setContent(''); setActiveTab('upload'); setAnalysisResults(null); }}
                                    className="text-xs text-red-500 hover:bg-red-50 px-3 py-1.5 rounded transition-colors"
                                >
                                    重新上传
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 max-w-5xl mx-auto w-full p-4 sm:p-6">
                        {isProcessing ? (
                             <div className="h-[400px] flex flex-col items-center justify-center text-gray-500 bg-white rounded-2xl border border-slate-200 shadow-sm">
                                <RefreshCw className="animate-spin mb-4 text-blue-500" size={40} />
                                <p className="font-medium text-slate-800">{processStatus}</p>
                            </div>
                        ) : (
                            <div className="bg-white min-h-[500px] rounded-2xl shadow-sm border border-slate-200 p-4 sm:p-8">
                                {fileName ? renderResultsView() : renderUploadView()}
                            </div>
                        )}
                        
                        {/* 调试信息: 如果需要查看提取的文本，可以取消注释下面这行 */}
                        {/* {content && <div className="mt-8 p-4 bg-gray-100 text-xs font-mono h-48 overflow-auto">{content}</div>} */}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
